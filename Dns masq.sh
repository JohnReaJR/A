# 选用 iptables+dnsmasq+ipset 方案执行 iptables_solution() { ${PACKAGE_INSTALL[int]} ipset dnsmasq resolvconf mtr # 创建 dnsmasq 规则文件 cat >/etc/dnsmasq.d/warp.conf << EOF #!/usr/bin/env bash server=8.8.8.8 server=1.1.1.1 # ----- WARP ----- # # > Youtube Premium server=/googlevideo.com/8.8.8.8 server=/youtube.com/8.8.8.8 server=/youtubei.googleapis.com/8.8.8.8 server=/fonts.googleapis.com/8.8.8.8 server=/yt3.ggpht.com/8.8.8.8 server=/gstatic.com/8.8.8.8 # > Custom ChatGPT ipset=/openai.com/warp ipset=/ai.com/warp # > IP api ipset=/ip.sb/warp ipset=/ip.gs/warp ipset=/ifconfig.co/warp ipset=/ip-api.com/warp # > Custom Website ipset=/www.cloudflare.com/warp ipset=/googlevideo.com/warp ipset=/youtube.com/warp ipset=/youtubei.googleapis.com/warp ipset=/fonts.googleapis.com/warp ipset=/yt3.ggpht.com/warp # > Netflix ipset=/fast.com/warp ipset=/netflix.com/warp ipset=/netflix.net/warp ipset=/nflxext.com/warp ipset=/nflximg.com/warp ipset=/nflximg.net/warp ipset=/nflxso.net/warp ipset=/nflxvideo.net/warp ipset=/239.255.255.250/warp # > TVBAnywhere+ ipset=/uapisfm.tvbanywhere.com.sg/warp # > Disney+ ipset=/bamgrid.com/warp ipset=/disney-plus.net/warp ipset=/disneyplus.com/warp ipset=/dssott.com/warp ipset=/disneynow.com/warp ipset=/disneystreaming.com/warp ipset=/cdn.registerdisney.go.com/warp # > TikTok ipset=/byteoversea.com/warp ipset=/ibytedtos.com/warp ipset=/ipstatp.com/warp ipset=/muscdn.com/warp ipset=/musical.ly/warp ipset=/tiktok.com/warp ipset=/tik-tokapi.com/warp ipset=/tiktokcdn.com/warp ipset=/tiktokv.com/warp EOF # 创建 PostUp 和 PreDown cat >/etc/wireguard/up << EOF #!/usr/bin/env bash ipset create warp hash:ip iptables -t mangle -N fwmark iptables -t mangle -A PREROUTING -j fwmark iptables -t mangle -A OUTPUT -j fwmark iptables -t mangle -A fwmark -m set --match-set warp dst -j MARK --set-mark 2 ip rule add fwmark 2 table warp ip route add default dev warp table warp iptables -t nat -A POSTROUTING -m mark --mark 0x2 -j MASQUERADE iptables -t mangle -A POSTROUTING -o warp -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu EOF cat >/etc/wireguard/down << EOF #!/usr/bin/env bash iptables -t mangle -D PREROUTING -j fwmark iptables -t mangle -D OUTPUT -j fwmark iptables -t mangle -D fwmark -m set --match-set warp dst -j MARK --set-mark 2 ip rule del fwmark 2 table warp iptables -t mangle -D POSTROUTING -o warp -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu iptables -t nat -D POSTROUTING -m mark --mark 0x2 -j MASQUERADE iptables -t mangle -F fwmark iptables -t mangle -X fwmark sleep 2 ipset destroy warp EOF chmod +x /etc/wireguard/up /etc/wireguard/down # 修改 warp.conf 和 warp.conf 文件 sed -i "s/^Post.*/#&/g; /Table/s/#//g; /Table/a\PostUp = /etc/wireguard/up\nPredown = /etc/wireguard/down" /etc/wireguard/warp.conf [ "$m" = 0 ] && sed -i "2i server=2606:4700:4700::1111\nserver=2001:4860:4860::8888\nserver=2001:4860:4860::8844" /etc/dnsmasq.d/warp.conf ! grep -q 'warp' /etc/iproute2/rt_tables && echo '250 warp' >>/etc/iproute2/rt_tables systemctl disable systemd-resolved --now >/dev/null 2>&1 && sleep 2 systemctl enable dnsmasq --now >/dev/null 2>&1 && sleep 2 } # 寻找最佳 MTU best_mtu() 
